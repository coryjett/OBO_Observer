<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agentgateway OBO Observer</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">OBO Observer</div>
      <div class="topbar-right">
        <span id="user-display" class="topbar-user" aria-hidden="true"></span>
        <a href="/login" id="login-link" class="topbar-login">Log in</a>
        <a href="/auth/logout" id="logout-link" class="topbar-logout" style="display: none;">Log out</a>
        <div id="status" class="status status-warn">Connecting...</div>
      </div>
    </header>

    <div id="wf-status" class="workflow-status-toast" aria-live="polite"></div>

    <main class="layout">
      <section class="card contexts">
        <div class="card-title-row">
          <div class="card-title">Contexts Hit</div>
          <button type="button" id="contexts-clear" class="btn-clear">Clear</button>
        </div>
        <ul id="context-list" class="context-list"></ul>
      </section>

      <section class="right-pane">
        <section class="card trace">
          <div class="card-title">Trace Graph</div>
          <div class="trace-graph-wrap" id="trace-graph-wrap">
            <svg id="trace-svg" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
        </section>

        <section class="card tokens">
          <details class="headers-details" id="headers-details">
            <summary class="headers-summary">Headers</summary>
            <p class="headers-help">All attributes parsed from the request log (as received by Agentgateway).</p>
            <div class="headers-split">
              <div class="headers-column">
                <div class="headers-column-title">Request</div>
                <pre id="headers-request" class="headers-display">Select a context to view headers.</pre>
              </div>
              <div class="headers-column">
                <div class="headers-column-title">Response</div>
                <pre id="headers-response" class="headers-display">Select a context to view headers.</pre>
              </div>
            </div>
            <div class="meta" id="event-meta">No event selected</div>
          </details>

          <details class="headers-details bodies-details" id="bodies-details">
            <summary class="headers-summary">Bodies</summary>
            <p class="headers-help">Request and response body from the access log (when present).</p>
            <div class="headers-split">
              <div class="headers-column">
                <div class="headers-column-title">Request body</div>
                <pre id="body-request" class="headers-display body-display">Select a context to view bodies.</pre>
              </div>
              <div class="headers-column">
                <div class="headers-column-title">Response body</div>
                <pre id="body-response" class="headers-display body-display">Select a context to view bodies.</pre>
              </div>
            </div>
          </details>

          <div class="workflow">
            <h3>Interactive OBO Flow</h3>
            <p class="workflow-help">
              1) Log in (top right) to get a session token. 2) Exchange via STS to get an OBO token. 3) Call MCP tools/list with the OBO Token. Agent Chat is available in the panel.
            </p>

            <div class="workflow-config">
              <div class="workflow-actions">
                <span class="workflow-exchange-row">
                  <label for="wf-exchange-mode" class="workflow-exchange-label">Exchange mode</label>
                  <select id="wf-exchange-mode" class="workflow-exchange-select" aria-label="STS token exchange mode">
                    <option value="delegation" selected>Delegation (subject + actor)</option>
                    <option value="impersonation">Impersonation (subject only)</option>
                  </select>
                  <button id="wf-step-2" type="button">2) Exchange via STS</button>
                </span>
                <span class="workflow-mcp-row">
                  <label for="wf-mcp-token-type" class="workflow-mcp-label">3) Call MCP tools/list</label>
                  <select id="wf-mcp-token-type" class="workflow-mcp-select" aria-label="Token type for MCP call">
                    <option value="obo-jwt" selected>OBO Token</option>
                    <option value="user-jwt">Session Token</option>
                    <option value="no-jwt">No JWT</option>
                  </select>
                  <button id="wf-step-3" type="button">Call</button>
                </span>
                <button id="wf-clear-jwts" type="button" class="btn-clear-jwts">Clear OBO Token</button>
              </div>
              <div class="workflow-tokens-wrapper is-collapsed" id="wf-tokens-wrapper">
                <div class="workflow-tokens-toggle-row">
                  <button type="button" id="wf-tokens-toggle" class="workflow-tokens-toggle" aria-expanded="false">
                    Session & OBO tokens <span class="workflow-tokens-toggle-icon" aria-hidden="true">▼</span>
                  </button>
                </div>
                <div class="workflow-results workflow-results--tokens-split" id="wf-tokens-container">
                <article class="workflow-token-details">
                  <h4 class="workflow-token-heading">Session Token <span id="wf-session-token-check" class="workflow-token-check" aria-hidden="true"></span></h4>
                  <div class="workflow-token-body">
                    <pre id="wf-user-jwt">(not generated yet)</pre>
                  </div>
                </article>
                <article class="workflow-token-details">
                  <h4 class="workflow-token-heading">OBO Token <span id="wf-obo-token-check" class="workflow-token-check" aria-hidden="true"></span></h4>
                  <div class="workflow-token-body">
                    <pre id="wf-obo-jwt">(not exchanged yet)</pre>
                  </div>
                </article>
                </div>
              </div>
              <div class="workflow-results workflow-results--tools-split">
                <article class="workflow-tools-panel">
                  <h4>Tools Response</h4>
                  <pre id="wf-tools">(tools/list not called yet)</pre>
                </article>
                <article class="workflow-agent-chat-panel">
                  <h4>Agent Chat</h4>
                  <p class="agent-chat-help">Chat with OpenAI using the MCP tools from the connected server (uses the workflow OBO token).</p>
                  <div class="agent-chat-token-row">
                    <label for="agent-openai-token">OpenAI API key</label>
                    <input type="password" id="agent-openai-token" placeholder="sk-…" autocomplete="off" />
                  </div>
                  <div id="agent-chat-messages" class="agent-chat-messages" aria-live="polite"></div>
                  <div class="agent-chat-input-row">
                    <input type="text" id="agent-chat-input" placeholder="Ask the agent…" aria-label="Agent chat message" />
                    <button type="button" id="agent-chat-send">Send</button>
                  </div>
                  <div id="agent-chat-error" class="agent-chat-error" role="alert"></div>
                </article>
              </div>
            </div>

            <details class="agentgateway-logs-details">
              <summary class="agentgateway-logs-summary">Agentgateway logs</summary>
              <pre id="agentgateway-logs" class="agentgateway-logs-pre">Connecting…</pre>
            </details>
          </div>
        </section>
      </section>
    </main>

    <script src="/app.js" defer></script>
  </body>
</html>
